<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito</title>
  <link rel="stylesheet" href="./css/index.css"> 
</head>
<body>
  <h1>Carrito de Compras</h1> 
  <button class="btn-volver" onclick="window.location.href='./index.html'">Volver a la tienda</button>
  
  <div id="carrito-container"></div>

  <div class="resumen-carrito">
    <p>Total productos: <span id="total-productos">0</span></p>
    <p>Total a pagar: <span id="total-precio">0.00</span> €</p>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const contenedor = document.getElementById('carrito-container');
    let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

    function agruparProductos(carrito) {
      const agrupado = {};
      carrito.forEach(producto => {
        const clave = producto.id || producto.nombre;
        if (agrupado[clave]) {
          agrupado[clave].cantidad += 1;
        } else {
          agrupado[clave] = { ...producto, cantidad: 1 };
        }
      });
      return Object.values(agrupado);
    }

    function renderCarrito() {
      contenedor.innerHTML = '';

      if (carrito.length === 0) {
        contenedor.innerHTML = '<p>Tu carrito está vacío.</p>';
        return;
      }

      const productosAgrupados = agruparProductos(carrito);

      // ✅ Crear UNA sola tabla
      const tabla = document.createElement('table');
      tabla.innerHTML = `
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Marca</th>
            <th>Sexo</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = tabla.querySelector('tbody');

      // ✅ Agregar una fila por cada producto agrupado
      productosAgrupados.forEach((producto) => {
        const fila = document.createElement('tr');

        fila.innerHTML = `
          <td><img src="${producto.imagen}" alt="${producto.nombre}" style="max-width: 100px;"></td>
          <td>${producto.nombre}</td>
          <td>${producto.marca}</td>
          <td>${producto.sexo}</td>
          <td>${producto.cantidad}</td>
          <td>${producto.precio} €</td>
          <td>${(producto.precio * producto.cantidad).toFixed(2)} €</td>
          <td><button class="eliminar-btn" data-nombre="${producto.nombre}">Eliminar uno</button></td>
        `;

        tbody.appendChild(fila);
      });

      contenedor.appendChild(tabla);

       // Actualizar totales SIEMPRE
  let totalProductos = carrito.length;
  let totalPrecio = carrito.reduce((sum, producto) => sum + parseFloat(producto.precio), 0);

      document.getElementById('total-productos').textContent = totalProductos;
      document.getElementById('total-precio').textContent = totalPrecio.toFixed(2);

      // Eventos de eliminar
      document.querySelectorAll('.eliminar-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          const nombre = e.target.dataset.nombre;
          eliminarUnProducto(nombre);
        });
      });
    }

    function eliminarUnProducto(nombre) {
      const index = carrito.findIndex(p => p.nombre === nombre);
      if (index !== -1) {
        carrito.splice(index, 1);
        localStorage.setItem('carrito', JSON.stringify(carrito));
        renderCarrito();
      }
    }

    renderCarrito();
  });
</script>

</body>
</html>